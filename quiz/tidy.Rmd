---
title: "Quiz: tidyverse functions"
date: "Generated `r Sys.time()`"
author: "By [Matt Dray](https://twitter.com/mattdray)"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
# Set chunk options
knitr::opts_chunk$set(echo = FALSE)

# Get packages
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(learnr))
suppressPackageStartupMessages(library(pacman))
```

```{r button, echo=FALSE}
library(shiny)
numericInput("n", "Set seed:", value = 50)
actionButton("goButton", "Randomise")
```

```{r prep}
# Character vector of tidyverse package names
tidy_pkgs <-
  tidyverse::tidyverse_packages() %>%  # calls character vector
  str_replace("\n", "") %>%  # remove newline
  str_replace(">=", "") %>%  # remove greater than or equal to
  str_replace("[:punct:]", "")  # remove punctuation
  
# Install and load full set of tidyverse packages
pacman::p_load(
  char = tidy_pkgs,
  character.only = TRUE  # read elements of character vector, not object name
)

# Tibble where each row is a package-function combination
tidy_funs <-
  tidy_pkgs %>% 
  tibble::enframe(name = NULL, value = "package") %>% 
  dplyr::mutate(
    functions = purrr::map(
      package,
      ~pacman::p_functions(.x, character.only = TRUE)
    )
  ) %>% 
  tidyr::unnest()
```

```{r get-questions}
# Function to get questions and answers
get_questions <- function() {
  
  # Randomly sample one row of the tidy_funs tibble
  # Output is a single package-function pair
  fun_sample <- sample_n(tidy_funs, 1)
  
  # Extract just the name of the function
  fun_name <<- select(fun_sample, functions) %>% pull()
  
  # Create lookup of packages that the function is duplicated in
  # Output is a character vector of packages that the function exists in
  dup_lookup <- tidy_funs %>% 
    filter(functions == fun_name) %>% 
    pull(package)
  
  # The correct answer is the one we already isolated
  ans_correct <<- fun_sample %>% select(package) %>% pull()
  
  # Wrong answer 1
  ans_wrong1 <<- tidy_funs %>%
    distinct(package) %>%  # get unique packages
    filter(!package %in% c(dup_lookup)) %>%  # ignore packages containing function
    sample_n(1) %>%  # choose a remaining package name at random
    pull()  # to character
  
  # Wrong answer 2
  ans_wrong2 <<- tidy_funs %>%
    distinct(package) %>%
    filter(!package %in% c(dup_lookup, ans_wrong1)) %>% # also ignore the first wrong answer
    sample_n(1) %>%
    pull()
  
  # Wrong answer 3
  ans_wrong3 <<- tidy_funs %>%
    distinct(package) %>%
    filter(!package %in% c(dup_lookup, ans_wrong1, ans_wrong2)) %>%
    sample_n(1) %>%
    pull()
  
}
```

```{r, server, context="server"}
# This chunk attempts to build text output that can be passed later to the
# quiz() and answer() functions

# tidy_funs should be generated in a chunk above this one

# Get function name for subject of question
fun_name <- eventReactive(
  input$goButton,
  { 
    set.seed(input$n)
    fun_sample <- sample_n(tidy_funs, 1)
    fun_name <- select(fun_sample, functions) %>% pull()
    paste0("The function `", fun_name, "` is from which tidyverse package?")
  }
)
output$fun_name_out <- renderText({ fun_name() })

# Get correct answer
ans_correct <- eventReactive(
  input$goButton,
  { 
    set.seed(input$n)
    fun_sample <- sample_n(tidy_funs, 1)
    ans_correct <- select(fun_sample, package) %>% pull()
    paste0("{", ans_correct, "}")
  }
)
output$ans_correct_out <- renderText({ ans_correct() })

# Get wrong answer
ans_wrong1 <- eventReactive(
  input$goButton,
  { 
    set.seed(input$n)
    fun_sample <- sample_n(tidy_funs, 1)
    fun_name <- select(fun_sample, functions) %>% pull()
    dup_lookup <- tidy_funs %>% 
      filter(functions == fun_name) %>% 
      pull(package)
    ans_correct <- fun_sample %>% select(package) %>% pull()
    ans_wrong1 <- tidy_funs %>%
      distinct(package) %>%  # get unique packages
      filter(!package %in% c(dup_lookup)) %>%  # ignore packages containing function
      sample_n(1) %>%  # choose a remaining package name at random
      pull()  # to character
    paste0("{", ans_wrong1, "}")
  }
)
output$ans_wrong1_out <- renderText({ ans_wrong1() })
```

```{r, button-output}
# Print these out just to prove the server code is working
textOutput("fun_name_out")
textOutput("ans_correct_out")
textOutput("ans_wrong1_out")
```

```{r q1}
# This chunk contains a 'regular' quiz()
# The fun_name, ans_correct and ans_wrong1 are generated in the
# get_questions() function, specified in the get-questions chunk

get_questions()

quiz(
  caption = "Question 1",
  question(
    text = paste0("The function `", fun_name, "` is from which tidyverse package?"),
    answer(paste0("{", ans_correct, "}"), correct = TRUE),
    answer(paste0("{", ans_wrong1, "}")),
    random_answer_order = TRUE
  )
)
```

```{r q2}
# Why won't textOutput() render inside quiz()?
# 
# quiz(
#   caption = "Question 2",
#   question(
#     text = textOutput("fun_name_out"),
#     answer(textOutput("ans_correct_out"), correct = TRUE),
#     answer(z),
#     random_answer_order = TRUE
#   )
# )
```
